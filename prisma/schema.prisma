// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPERADMIN  @map("1")
  ADMIN       @map("2")
  STANDARD    @map("3")
  READONLY    @map("4")
}

model User {
  id                Int               @id @default(autoincrement())
  email             String            @unique
  password          String
  firstName         String
  lastName          String
  avatarUrl         String?
  createdAt         DateTime          @default(now())
  role              Role              @default(READONLY)

  projects          Project[]         @relation("ProjectAssignments")
  jobs              Job[]             @relation("JobAssignments")
  addressHistory    AddressHistory[]
  clientHistory     ClientHistory[]   
  projectHistory    ProjectHistory[]
  jobHistory        JobHistory[]
  userHistory       UserHistory[]     @relation("UserToHistory")
  actedUserHistory  UserHistory[]     @relation("ActorToHistory")
}

enum UserHistoryEventType {
  CREATED
  DELETED

  EMAIL_CHANGED
  PASSWORD_CHANGED
  FIRSTNAME_CHANGED
  LASTNAME_CHANGED
  ROLE_CHANGED
  AVATARURL_CHANGED
}

enum UserField {
  email
  password
  firstName
  lastName
  role
  avatarUrl
}

model UserHistory {
  id        Int                     @id @default(autoincrement())
  userId    Int
  user      User                    @relation("UserToHistory", fields: [userId], references: [id], onDelete: Cascade)
  
  actorId   Int
  actor     User                    @relation("ActorToHistory", fields: [actorId], references: [id], onDelete: SetNull)

  eventType UserHistoryEventType
  field     UserField?
  oldValue  Json?
  newValue  Json?

  createdAt DateTime  @default(now())
}

model Address {
  id         Int                @id @default(autoincrement())
  street     String
  city       String
  state      String
  country    String
  postalCode String
  
  clientId   Int                @unique
  client     Client             @relation(fields: [clientId], references: [id])
  history    AddressHistory[]
}

enum AddressHistoryEventType {
  CREATED
  DELETED

  STREET_CHANGED
  CITY_CHANGED
  STATE_CHANGED
  COUNTRY_CHANGED
  POSTALCODE_CHANGED
  CLIENT_CHANGED
}

enum AddressField {
  street
  city
  state
  country
  postalCode
  client
}

model AddressHistory {
  id        Int      @id @default(autoincrement())
  addressId Int
  address   Address  @relation(fields: [addressId], references: [id], onDelete: Cascade)
  
  actorId   Int
  actor     User     @relation(fields: [actorId], references: [id], onDelete: SetNull)

  eventType AddressHistoryEventType
  field     AddressField?
  oldValue  Json?
  newValue  Json?

  createdAt DateTime @default(now())
}

model Client {
  id           Int       @id @default(autoincrement())
  name         String    @unique
  createdAt    DateTime  @default(now())
  email        String?   @unique
  phone        String?
  website      String?   
  description  String?

  address      Address?
  projects     Project[]

  history      ClientHistory[]
}

enum ClientHistoryEventType {
  CREATED
  DELETED

  EMAIL_CHANGED
  PHONE_CHANGED
  WEBSITE_CHANGED
  DESCRIPTION_CHANGED
  NAME_CHANGED
  ADDRESS_CHANGED
}

enum ClientField {
  name
  email
  phone
  website
  description
  address
}

model ClientHistory {
  id        Int      @id @default(autoincrement())
  clientId  Int
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  actorId   Int
  actor     User     @relation(fields: [actorId], references: [id], onDelete: SetNull)
  eventType ClientHistoryEventType
  field     ClientField?
  oldValue  Json?
  newValue  Json?

  createdAt DateTime @default(now())
}

enum Priority {
  LOW     @map("1")
  MEDIUM  @map("2")
  HIGH    @map("3")
  URGENT  @map("4")
}

enum Status {
  NOT_STARTED @map("1")
  IN_PROGRESS @map("2")
  ON_HOLD     @map("3")
  COMPLETED   @map("4")
  CANCELLED   @map("5")
}

model Project {
  id            Int               @id @default(autoincrement())
  name          String
  description   String?
  createdAt     DateTime          @default(now())
  startDate     DateTime?
  dueDate       DateTime?
  finishDate    DateTime?
  priority      Priority          @default(LOW)
  status        Status            @default(NOT_STARTED)

  clientId      Int
  client        Client            @relation(fields: [clientId], references: [id])
  jobs          Job[]
  assignedTo    User[]            @relation("ProjectAssignments")
  history       ProjectHistory[]
}

enum ProjectHistoryEventType {
  CREATED
  DELETED

  NAME_CHANGED
  DESCRIPTION_CHANGED
  STATUS_CHANGED
  PRIORITY_CHANGED
  START_DATE_CHANGED
  DUE_DATE_CHANGED
  FINISH_DATE_CHANGED
  CLIENT_CHANGED
}

enum ProjectField {
  name
  description
  status
  priority
  startDate
  dueDate
  finishDate
  client
}

model ProjectHistory {
  id        Int       @id @default(autoincrement())
  projectId Int
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  actorId   Int
  actor     User      @relation(fields: [actorId], references: [id], onDelete: SetNull)
  
  eventType ProjectHistoryEventType
  field     ProjectField?
  oldValue  Json?
  newValue  Json?

  createdAt DateTime  @default(now())
}

model Job {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startDate   DateTime?
  dueDate     DateTime?
  finishDate  DateTime?
  status      Status    @default(NOT_STARTED)
  priority    Priority   @default(LOW)

  projectId   Int
  project     Project    @relation(fields: [projectId], references: [id])
  assignedTo  User[]     @relation("JobAssignments")
  history     JobHistory[]
}

enum JobHistoryEventType {
  CREATED
  DELETED

  TITLE_CHANGED
  DESCRIPTION_CHANGED
  STATUS_CHANGED
  PRIORITY_CHANGED
  START_DATE_CHANGED
  DUE_DATE_CHANGED
  FINISH_DATE_CHANGED
  PROJECT_CHANGED
  ASSIGNED_USERS_CHANGED
}

enum JobField {
  title
  description
  status
  priority
  startDate
  dueDate
  finishDate
  project
}

model JobHistory {
  id        Int       @id @default(autoincrement())
  jobId     Int
  job       Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  actorId   Int
  actor     User      @relation(fields: [actorId], references: [id], onDelete: SetNull)
  eventType JobHistoryEventType
  field     JobField?
  oldValue  Json?
  newValue  Json?
  createdAt DateTime  @default(now())
}
